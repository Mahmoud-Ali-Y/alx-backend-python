#!/bin/bash

# Script: kubctl-0x03.sh
# Purpose: Perform rolling update of Django app and test downtime

DEPLOYMENT="django-blue"
SERVICE="django-messaging-service"
NAMESPACE="default"

echo "üöÄ Applying updated deployment (blue_deployment.yaml)..."
kubectl apply -f blue_deployment.yaml -n "$NAMESPACE"

echo "‚è≥ Monitoring rollout status..."
kubectl rollout status deployment/"$DEPLOYMENT" -n "$NAMESPACE"

if [ $? -ne 0 ]; then
  echo "‚ùå Rollout failed!"
  exit 1
fi

echo "‚úÖ Rollout in progress, starting downtime check..."

# Get service IP and port
CLUSTER_IP=$(kubectl get svc "$SERVICE" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}')
PORT=$(kubectl get svc "$SERVICE" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}')

if [ -z "$CLUSTER_IP" ]; then
  echo "‚ùå Could not find ClusterIP for $SERVICE"
  exit 1
fi

URL="http://$CLUSTER_IP:$PORT/"

echo "üåê Continuously sending requests to $URL during rollout..."
for i in {1..20}; do
  curl -s -o /dev/null -w "Attempt $i: %{http_code}\n" "$URL"
  sleep 1
done

echo "üì¶ Checking current pods after rollout..."
kubectl get pods -l app=django-messaging,version=blue -o wide -n "$NAMESPACE"

echo "üéâ Rolling update completed successfully."