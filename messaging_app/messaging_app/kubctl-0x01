#!/bin/bash

# Script: kubctl-0x01.sh
# Purpose: Scale Django app deployment, verify pods, load test, and monitor resource usage.

DEPLOYMENT_NAME="django-messaging-deployment"
SERVICE_NAME="django-messaging-service"
NAMESPACE="default"

echo "üöÄ Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=3 -n "$NAMESPACE"

if [ $? -ne 0 ]; then
  echo "‚ùå Failed to scale deployment."
  exit 1
fi

echo "‚è≥ Waiting for pods to be ready..."
kubectl rollout status deployment/"$DEPLOYMENT_NAME" -n "$NAMESPACE"

echo "‚úÖ Deployment scaled. Checking pods:"
kubectl get pods -n "$NAMESPACE" -o wide

echo "üîç Getting ClusterIP of the Django service..."
CLUSTER_IP=$(kubectl get svc "$SERVICE_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.clusterIP}')
PORT=$(kubectl get svc "$SERVICE_NAME" -n "$NAMESPACE" -o jsonpath='{.spec.ports[0].port}')

if [ -z "$CLUSTER_IP" ]; then
  echo "‚ùå Could not fetch ClusterIP for $SERVICE_NAME"
  exit 1
fi

echo "‚úÖ Service reachable at http://$CLUSTER_IP:$PORT"

echo "‚ö° Running load test with wrk (10s, 100 connections)..."
wrk -t4 -c100 -d10s http://$CLUSTER_IP:$PORT/

echo "üìä Monitoring resource usage (pods & nodes)..."
kubectl top pods -n "$NAMESPACE"
kubectl top nodes